{% extends 'problems/base.html' %}
{% load static %}
{% load problem_extras %}

{% block content %}
<style>
/* ========== 整页卡片 + 强制换行 ========== */
.container {
    max-width: 100%;
    padding: 0 1rem;
}

/* 表格布局调整 - 减少关键词列宽度 */
.table th {
    width: 150px; /* 固定关键词列宽度 */
    min-width: 150px;
    max-width: 200px;
    padding-right: 1rem;
    vertical-align: top;
}

.table td {
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    padding-left: 0.5rem; /* 减少左侧内边距 */
}

/* 确保所有文本内容都能自动换行 */
.card-body,
.card-body td,
.card-body th,
.card-body p,
.card-body div {
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal;
}

/* 表格布局 */
.card-body table {
    width: 100%;
}

.card-body td,
.card-body th {
    word-break: break-word;
    white-space: normal;
}

/* 代码块处理 */
.card-body pre {
    white-space: pre-wrap;
    word-break: break-word;
    overflow-x: auto;
    position: relative; /* 为复制按钮定位提供上下文 */
}

.card-body code {
    word-break: break-word;
    color: inherit;
}

/* 复制按钮悬停效果 - 修正位置 */
.card-body pre .copy-btn {
    position: absolute;
    top: 4px;
    right: 4px; /* 改为右上角 */
    font-size: 0.75rem;
    padding: 2px 6px;
    opacity: 0;
    transition: opacity .2s;
    background: #0d6efd;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    z-index: 10;
}

/* 单行代码样式 - 改为块级元素占满整行 */
.card-body .inline-code {
    position: relative; /* 为行内代码复制按钮提供定位上下文 */
    display: block; /* 改为块级元素 */
    width: 100%; /* 占满整行 */
    margin: 0.5rem 0; /* 添加上下边距 */
    padding: 0.75rem; /* 与代码块一致的内边距 */
    background: #f1f3f4; /* 与代码块一致的背景色 */
    border-radius: 3px; /* 与代码块一致的圆角 */
    word-break: break-all; /* 确保长代码字符串换行 */
    white-space: pre-wrap; /* 允许换行 */
    color: inherit;
}

.card-body .inline-code .copy-btn {
    position: absolute;
    top: 4px;
    right: 4px; /* 改为右上角 */
    font-size: 0.75rem;
    padding: 2px 6px;
    opacity: 0;
    transition: opacity .2s;
    background: #0d6efd;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    z-index: 10;
}

.card-body pre:hover .copy-btn,
.card-body .inline-code:hover .copy-btn {
    opacity: 1;
}

/* 图片自适应 */
.card-body img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
}

/* 行内代码样式 - 移除不再需要的规则 */
.card-body code:not(pre code) {
    /* 这些样式现在由 .inline-code 类处理 */
}

/* 代码块样式 */
.card-body pre {
    position: relative;
    background: #f1f3f4;
    padding: .75rem;
    border-radius: 3px;
    overflow-x: auto;
    word-break: break-all; /* 确保代码中的长字符串换行 */
    color: inherit;
}

.card-body pre code {
    background: transparent;
    padding: 0;
    white-space: pre-wrap; /* 修改这里确保代码也能换行 */
    word-break: break-all; /* 强制长字符串换行 */
    color: inherit;
}

/* 引用块样式 */
.card-body blockquote {
    margin: 1em 0;
    padding: 0 20px;
    color: #666;
    border-left: 2px solid #ccc;
}

/* 确保描述字段的内容换行 */
#desc-cell, #rc-cell, #sol-cell, #oth-cell {
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    max-width: 100%;
}

/* 针对特别长的无空格字符串 */
.break-all {
    word-break: break-all;
    overflow-wrap: break-word;
}

/* 调整表格行间距 */
.table-borderless tr {
    border-bottom: 1px solid #dee2e6;
}

.table-borderless tr:last-child {
    border-bottom: none;
}
</style>

<h2>{{ problem.title|safe }}</h2>

<div class="container mt-4">
<div class="card shadow-sm">
<div class="card-body p-3">
<table class="table table-borderless mb-0">
  <tr>
    <th class="text-nowrap">Key Words</th>
    <td>{{ problem.key_words|safe }}</td>
  </tr>

  {# 1.  Description  #}
  <tr>
    <th>Description</th>
    <td>
      <div id="desc-cell" class="break-all">{% if problem.description %}{{ problem.description|safe }}{% else %}-{% endif %}</div>
    </td>
  </tr>

  {# 2.  Root Cause  #}
  <tr>
    <th>Root Cause</th>
    <td>
      <div id="rc-cell" class="break-all">{% if problem.root_cause %}{{ problem.root_cause|safe }}{% else %}-{% endif %}</div>
      {% load problem_extras %}
      {% with root_cause_files=problem|get_field_files:'root_cause' %}
        {% if root_cause_files %}
          <div class="mt-1 small">
            <strong>Attachments:</strong>
            {% for filename, url in root_cause_files %}
              <a href="{{ url }}" target="_blank" class="badge bg-info text-decoration-none me-1">{{ filename }}</a>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </td>
  </tr>

  {# 3.  Solutions  #}
  <tr>
    <th>Solutions</th>
    <td>
      <div id="sol-cell" class="break-all">{% if problem.solutions %}{{ problem.solutions|safe }}{% else %}-{% endif %}</div>
      {% with solutions_files=problem|get_field_files:'solutions' %}
        {% if solutions_files %}
          <div class="mt-1 small">
            <strong>Attachments:</strong>
            {% for filename, url in solutions_files %}
              <a href="{{ url }}" target="_blank" class="badge bg-info text-decoration-none me-1">{{ filename }}</a>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </td>
  </tr>

  {# 4.  Others  #}
  <tr>
    <th>Others</th>
    <td>
      <div id="oth-cell" class="break-all">{% if problem.others %}{{ problem.others|safe }}{% else %}-{% endif %}</div>
      {% with others_files=problem|get_field_files:'others' %}
        {% if others_files %}
          <div class="mt-1 small">
            <strong>Attachments:</strong>
            {% for filename, url in others_files %}
              <a href="{{ url }}" target="_blank" class="badge bg-info text-decoration-none me-1">{{ filename }}</a>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </td>
  </tr>

  <tr>
    <th>Updated</th>
    <td>{{ problem.update_time|date:"Y-m-d H:i" }}</td>
  </tr>
</table>
</div>
</div>
</div>

<script src="{% static 'libs/prismjs/prism.min.js' %}" defer></script>
<script src="{% static 'libs/prismjs/plugins/autoloader/prism-autoloader.min.js' %}" defer></script>
<link href="{% static 'libs/prismjs/themes/prism.min.css' %}" rel="stylesheet"/>
<script src="{% static 'libs/clipboard/clipboard-polyfill.min.js' %}" defer></script>

<script>
// 从 problem_list.html 复制的 Markdown 渲染逻辑
marked.setOptions({
  gfm: true,               // GitHub Flavored Markdown
  breaks: true,            // 换行符直接换行
  highlight: function (code, lang) {
    if (lang && Prism.languages[lang]) {
      return Prism.highlight(code, Prism.languages[lang], lang);
    }
    return Prism.highlight(code, Prism.languages.plaintext, 'plaintext');
  }
});

function addCopyListeners() {
  document.querySelectorAll('.copy-btn').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      let codeElement;
      if (this.parentElement.tagName === 'CODE') {
        // 行内代码
        codeElement = this.parentElement;
      } else if (this.parentElement.tagName === 'PRE') {
        // 代码块
        codeElement = this.nextElementSibling;
      }

      if (codeElement) {
        let codeText = codeElement.textContent;
        if (codeText.includes('Copy')) {
          codeText = codeText.replace('Copy', '').trim();
        }

        try {
          clipboard.writeText(codeText).then(() => {
            const originalText = this.textContent;
            this.textContent = 'Copied!';
            setTimeout(() => {
              this.textContent = originalText;
            }, 1500);
          }).catch(err => {
            console.error('Failed to copy text: ', err);
          });
        } catch (err) {
          console.error('Clipboard API not available', err);
          alert('Your browser does not support the Clipboard API. Please copy the code manually.');
        }
      }
    });
  });
}

function renderMarkdown(src) {
  let html = marked.parse(src);

  // 代码块加行号和拷贝按钮
  html = html.replace(
    /<pre><code(\s+class="[^"]*")?>([\s\S]*?)<\/code><\/pre>/g,
    (match, className, code) => {
      if (className) {
        return `
          <pre><button class="btn btn-sm btn-outline-secondary copy-btn">Copy</button><code${className}>${code}</code></pre>
        `;
      } else {
        return `
          <pre><button class="btn btn-sm btn-outline-secondary copy-btn">Copy</button><code>${code}</code></pre>
        `;
      }
    }
  );

  // 行内代码：浅灰背景 + 拷贝按钮
  html = html.replace(/<code(\s+class="[^"]*")?>(.*?)<\/code>/g, (match, className, code) => {
    if (className) {
      return `
        <code${className} class="inline-code"><button class="btn btn-sm btn-outline-secondary copy-btn">Copy</button>${code}</code>
      `;
    } else {
      return `
        <code class="inline-code"><button class="btn btn-sm btn-outline-secondary copy-btn">Copy</button>${code}</code>
      `;
    }
  });

  // 表格包一层可滚动 div（解决超宽）
  html = html.replace(/<table>/g, '<div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light">');
  html = html.replace(/<\/table>/g, '</table></div>');

  // 弹出后让 Prism 高亮 + 按钮可用
  setTimeout(() => {
    Prism.highlightAll();
    addCopyListeners();
  }, 0);

  return html;
}

// 从 problem_list.html 复制的 preserveText 函数
function preserveText(text, editorType = 'plain') {
  if (!text) return '-';
  const unescapedText = unescapeHtml(text);
  if (editorType === 'markdown') {
    const html = renderMarkdown(unescapedText);
    setTimeout(() => Prism.highlightAll(), 0);
    return html;
  } else {
    // 纯文本模式：不反转义，直接显示HTML实体，用div包裹保持换行
    return `<div style="white-space: pre-wrap; font-family: inherit;">${text}</div>`;
  }
}

// 从 problem_list.html 复制的 unescapeHtml 函数
function unescapeHtml(str) {
  if (typeof str !== 'string') return str;
  try {
    const doc = new DOMParser().parseFromString(str, 'text/html');
    return doc.documentElement.textContent;
  } catch (e) {
    const textarea = document.createElement('textarea');
    textarea.innerHTML = str;
    return textarea.value;
  }
}

// 获取问题数据
const problemData = {
  id: {{ problem.id }},
  key_words: '{{ problem.key_words|escapejs }}',
  title: '{{ problem.title|escapejs }}',
  description: '{{ problem.description|escapejs }}',
  description_editor_type: '{{ problem.description_editor_type|default:"plain"|escapejs }}',
  root_cause: '{{ problem.root_cause|escapejs }}',
  root_cause_editor_type: '{{ problem.root_cause_editor_type|default:"plain"|escapejs }}',
  root_cause_file: '{% if problem.root_cause_file %}{{ problem.root_cause_file.url|escapejs }}{% endif %}',
  solutions: '{{ problem.solutions|escapejs }}',
  solutions_editor_type: '{{ problem.solutions_editor_type|default:"plain"|escapejs }}',
  solutions_file: '{% if problem.solutions_file %}{{ problem.solutions_file.url|escapejs }}{% endif %}',
  others: '{{ problem.others|escapejs }}',
  others_editor_type: '{{ problem.others_editor_type|default:"plain"|escapejs }}',
  others_file: '{% if problem.others_file %}{{ problem.others_file.url|escapejs }}{% endif %}',
  create_time: '{{ problem.create_time|date:"Y-m-d H:i" }}',
  update_time: '{{ problem.update_time|date:"Y-m-d H:i" }}',
  is_public: {{ problem.is_public|yesno:"true,false" }},
  public_token: '{{ problem.public_token }}'
};

// 渲染字段 - 使用与problem_list.html双击详情相同的逻辑
function renderFields() {
  const fields = ['description', 'root_cause', 'solutions', 'others'];

  fields.forEach(field => {
    const cellId = `${field === 'description' ? 'desc' : field === 'root_cause' ? 'rc' : field === 'solutions' ? 'sol' : 'oth'}-cell`;
    const cell = document.getElementById(cellId);
    if (!cell) return;

    const text = problemData[field];
    const editorType = problemData[`${field}_editor_type`] || 'plain';

    // 使用与problem_list.html中相同的preserveText函数
    const html = preserveText(text, editorType);
    cell.innerHTML = html;
  });
}

// 页面加载完成后渲染
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, rendering fields...');
  renderFields();

  // 重新绑定复制按钮事件
  setTimeout(() => {
    addCopyListeners();
  }, 100);
});
</script>
{% endblock %}
