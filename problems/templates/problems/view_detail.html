{% extends 'problems/base.html' %}
{% load problem_extras %}
{% load static %}

{% block content %}
<style>
/* ========== 整页卡片 + 强制换行 ========== */
.container {
    max-width: 100%;
    padding: 0 1rem;
}

/* 表格布局调整 - 减少关键词列宽度 */
.table th {
    width: 150px; /* 固定关键词列宽度 */
    min-width: 150px;
    max-width: 200px;
    padding-right: 1rem;
    vertical-align: top;
}

.table td {
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    padding-left: 0.5rem; /* 减少左侧内边距 */
}

/* 确保所有文本内容都能自动换行 */
.card-body,
.card-body td,
.card-body th,
.card-body p,
.card-body div {
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal;
}

/* 表格布局 */
.card-body table {
    width: 100%;
}

.card-body td,
.card-body th {
    word-break: break-word;
    white-space: normal;
}

/* 代码块处理 */
.card-body pre {
    white-space: pre-wrap;
    word-break: break-word;
    overflow-x: auto;
    position: relative; /* 为复制按钮定位提供上下文 */
}

.card-body code {
    word-break: break-word;
    color: inherit;
}

/* 复制按钮悬停效果 - 修正位置 */
.card-body pre .copy-btn {
    position: absolute;
    top: 4px;
    right: 4px; /* 改为右上角 */
    font-size: 0.75rem;
    padding: 2px 6px;
    opacity: 0;
    transition: opacity .2s;
    background: #0d6efd;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    z-index: 10;
}

/* 单行代码样式 - 改为块级元素占满整行 */
.card-body .inline-code {
    position: relative; /* 为行内代码复制按钮提供定位上下文 */
    display: block; /* 改为块级元素 */
    width: 100%; /* 占满整行 */
    margin: 0.5rem 0; /* 添加上下边距 */
    padding: 0.75rem; /* 与代码块一致的内边距 */
    background: #f1f3f4; /* 与代码块一致的背景色 */
    border-radius: 3px; /* 与代码块一致的圆角 */
    word-break: break-all; /* 确保长代码字符串换行 */
    white-space: pre-wrap; /* 允许换行 */
    color: inherit;
}

.card-body .inline-code .copy-btn {
    position: absolute;
    top: 4px;
    right: 4px; /* 改为右上角 */
    font-size: 0.75rem;
    padding: 2px 6px;
    opacity: 0;
    transition: opacity .2s;
    background: #0d6efd;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    z-index: 10;
}

.card-body pre:hover .copy-btn,
.card-body .inline-code:hover .copy-btn {
    opacity: 1;
}

/* 图片自适应 */
.card-body img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
}

/* 行内代码样式 - 移除不再需要的规则 */
.card-body code:not(pre code) {
    /* 这些样式现在由 .inline-code 类处理 */
}

/* 代码块样式 */
.card-body pre {
    position: relative;
    background: #f1f3f4;
    padding: .75rem;
    border-radius: 3px;
    overflow-x: auto;
    word-break: break-all; /* 确保代码中的长字符串换行 */
    color: inherit;
}

.card-body pre code {
    background: transparent;
    padding: 0;
    white-space: pre-wrap; /* 修改这里确保代码也能换行 */
    word-break: break-all; /* 强制长字符串换行 */
    color: inherit;
}

/* 引用块样式 */
.card-body blockquote {
    margin: 1em 0;
    padding: 0 20px;
    color: #666;
    border-left: 2px solid #ccc;
}

/* 确保描述字段的内容换行 */
#desc-cell, #rc-cell, #sol-cell, #oth-cell {
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    max-width: 100%;
}

/* 针对特别长的无空格字符串 */
.break-all {
    word-break: break-all;
    overflow-wrap: break-word;
}

/* 调整表格行间距 */
.table-borderless tr {
    border-bottom: 1px solid #dee2e6;
}

.table-borderless tr:last-child {
    border-bottom: none;
}
</style>

<h2>{{ problem.title }}</h2>

<div class="container mt-4">
<div class="card shadow-sm">
<div class="card-body p-3">
<table class="table table-borderless mb-0">
  <tr>
    <th class="text-nowrap">Key Words</th>
    <td>{{ problem.key_words|default:"-" }}</td>
  </tr>

  {# 1.  Description  #}
  <tr>
    <th>Description</th>
    <td>
      <div id="desc-cell" class="break-all">{% if problem.description %}{{ problem.description }}{% else %}-{% endif %}</div>
    </td>
  </tr>

  {# 2.  Root Cause  #}
  <tr>
    <th>Root Cause</th>
    <td>
      <div id="rc-cell" class="break-all">{% if problem.root_cause %}{{ problem.root_cause }}{% else %}-{% endif %}</div>
      {% if problem.root_cause_file %}
        <div class="mt-1 small">Attachment: <a href="{{ problem.root_cause_file.url }}" target="_blank">{{ problem.root_cause_file.name|basename }}</a></div>
      {% endif %}
    </td>
  </tr>

  {# 3.  Solutions  #}
  <tr>
    <th>Solutions</th>
    <td>
      <div id="sol-cell" class="break-all">{% if problem.solutions %}{{ problem.solutions }}{% else %}-{% endif %}</div>
      {% if problem.solutions_file %}
        <div class="mt-1 small">Attachment: <a href="{{ problem.solutions_file.url }}" target="_blank">{{ problem.solutions_file.name|basename }}</a></div>
      {% endif %}
    </td>
  </tr>

  {# 4.  Others  #}
  <tr>
    <th>Others</th>
    <td>
      <div id="oth-cell" class="break-all">{% if problem.others %}{{ problem.others }}{% else %}-{% endif %}</div>
      {% if problem.others_file %}
        <div class="mt-1 small">Attachment: <a href="{{ problem.others_file.url }}" target="_blank">{{ problem.others_file.name|basename }}</a></div>
      {% endif %}
    </td>
  </tr>

  <tr>
    <th>Updated</th>
    <td>{{ problem.update_time|date:"Y-m-d H:i" }}</td>
  </tr>
</table>
</div>
</div>
</div>

{# 仅用于 Markdown 渲染的隐藏容器 #}
<div id="md-cache" style="display:none;">
  <div data-field="description">{{ problem|field_json:'description' }}</div>
  <div data-field="root_cause">{{ problem|field_json:'root_cause' }}</div>
  <div data-field="solutions">{{ problem|field_json:'solutions' }}</div>
  <div data-field="others">{{ problem|field_json:'others' }}</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/clipboard-polyfill/dist/clipboard-polyfill.min.js"></script>

<script>
/* ---------- 通用渲染 ---------- */
marked.setOptions({
  gfm:true,breaks:true,
  highlight:function(c,l){
    return Prism.languages[l]?Prism.highlight(c,Prism.languages[l],l):Prism.highlight(c,Prism.languages.plaintext,'plaintext');
  }
});

function renderMarkdown(src){
  let html=marked.parse(src);
  html=html.replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g,(m,c)=>`<pre><button class="btn btn-sm btn-outline-secondary copy-btn">Copy</button><code>${c}</code></pre>`); 
  html=html.replace(/<code>(.*?)<\/code>/g,(m,c)=>`<code class="inline-code"><button class="btn btn-sm btn-outline-secondary copy-btn">Copy</button>${c}</code>`); 
  html=html.replace(/<table>/g,'<div class="table-responsive"><table class="table table-sm table-bordered"><thead class="table-light">');
  html=html.replace(/<\/table>/g,'</table></div>');
  setTimeout(()=>Prism.highlightAll(),0);
  return html;
}
function addCopyListeners(){
  document.querySelectorAll('td .copy-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const code=btn.parentElement.tagName==='CODE'?btn.parentElement.textContent.replace('Copy','').trim():btn.nextElementSibling.textContent;
      clipboard.writeText(code).then(()=>{btn.textContent='Copied';setTimeout(()=>btn.textContent='Copy',1500);});
    });
  });
}

/* ---------- 逐格渲染 ---------- */
const editors={
  description:'{{ problem.description_editor_type|default:"plain" }}',
  root_cause :'{{ problem.root_cause_editor_type|default:"plain" }}',
  solutions  :'{{ problem.solutions_editor_type|default:"plain" }}',
  others     :'{{ problem.others_editor_type|default:"plain" }}'
};
['description','root_cause','solutions','others'].forEach(f=>{
  const src=JSON.parse(document.querySelector(`#md-cache div[data-field="${f}"]`).textContent);
  const cell=document.querySelector(`#${f==='description'?'desc-cell':f==='root_cause'?'rc-cell':f==='solutions'?'sol-cell':'oth-cell'}`);
  if(!src.trim()){cell.innerHTML='-';return;}
  cell.innerHTML= editors[f]==='markdown'?renderMarkdown(src):src.split('\n').join('<br>');
});
addCopyListeners();
</script>
{% endblock %}
