{% extends 'problems/base.html' %}
{% load static %}
{% load problem_extras %}
{% block content %}
<style>
  .form-check-input.custom-checkbox {
    width: 1.2em;
    height: 1.2em;
    margin-top: 0.1em;
    background-color: #fff;
    border: 2px solid #0d6efd;
    border-radius: 0.25em;
  }

  .form-check-input.custom-checkbox:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='m6 10 3 3 6-6'/%3e%3c/svg%3e");
  }

  .form-check-input.custom-checkbox:focus {
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }
  
  .editor-container {
    position: relative;
    margin-bottom: 1rem;
  }
  .form-wrapper {
    max-width: 50vw !important;   
    margin: 0 auto;           
  }
  /* 图片自适应样式 */
  img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
  }

  /* 警告框增强样式 */
  .alert-warning {
    border-left: 4px solid #ffc107;
    background-color: #fff8e1;
  }

  .alert-warning code {
    background-color: #fff3cd;
    padding: 2px 4px;
    border-radius: 3px;
    color: #856404;
    font-weight: bold;
  }
</style>

<div class="container py-5">
  <div class="row">
    <div class="col-12">
      <a href="{% url 'cv_base_list' %}" class="btn btn-outline-secondary btn-sm mb-3">
        <i class="bi bi-arrow-left"></i> Back to List
      </a>
    </div>
  </div>
  <div class="card custom-card p-4">
    <h2 class="mb-4 text-center">{{ action }} Record</h2>
      <!-- 添加消息显示区域 -->
      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      {% endif %}

      <!-- 显示表单非字段错误 -->
      {% if form.non_field_errors %}
        <div class="alert alert-danger">
          {% for error in form.non_field_errors %}
            {{ error }}
          {% endfor %}
        </div>
      {% endif %}

      <!-- Markdown 编辑规范警告 -->
      <div class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
        <strong>⚠️ Markdown 编辑规范：</strong>
        <ul class="mb-0 mt-2 small">
          <li>所有代码必须用 <code>```</code> 包裹，例如： <code>```html\n&lt;html&gt;\n&lt;/html&gt;\n```</code></li>
          <li>裸代码（不在代码块中）将无法正常显示</li>
          <li>支持语法高亮：html, javascript, python, css, sql 等</li>
        </ul>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <form method="post" enctype="multipart/form-data" class="row g-3 form-wrapper">
      {% csrf_token %}

      <!-- 隐藏字段用于存储编辑器类型 -->
      <input type="hidden" id="id_content_editor_type" name="content_editor_type" value="markdown">

      <!-- Record Date -->
      <div class="col-12">
        <div class="d-flex align-items-center gap-2">
          <label class="form-label mb-0" for="{{ form.record_date.id_for_label }}" style="min-width: 100px;">Record Date</label>
          {{ form.record_date }}
          <button class="btn btn-outline-secondary" type="button" onclick="openDateModal()" style="padding: 0.5rem 0.75rem;">
            <i class="bi bi-calendar"></i>
          </button>
          {% if form.record_date.errors %}<div class="text-danger small">{{ form.record_date.errors|join:", " }}</div>{% endif %}
        </div>
      </div>

      <!-- Title -->
      <div class="col-12">
        <div class="d-flex align-items-center gap-2">
          <label class="form-label mb-0" for="{{ form.title.id_for_label }}" style="min-width: 100px;">Title</label>
          {{ form.title }}
        </div>
        {% if form.title.errors %}<div class="text-danger small">{{ form.title.errors|join:", " }}</div>{% endif %}
      </div>

      <!-- Content with Markdown Editor -->
      <div class="col-12 editor-container">
        <label class="form-label" for="content-editor">{{ form.content.label }}</label> 
        <textarea id="content-editor" name="content" rows="8" class="form-control">{{ form.instance.content|default_if_none:"" }}</textarea>
        {% if form.content.errors %}<div class="text-danger small">{{ form.content.errors|join:", " }}</div>{% endif %}
      </div>

      <!-- Existing Files -->
      <div class="col-12">
        <label class="form-label">Current Attachments (multiple, max {{ max_file_size_str }} each)</label>
        <input type="file" name="content_files" multiple class="form-control" accept="*/*">

        {% if cv_record %}
          {% with content_files=cv_record|get_field_files:'content' %}
            {% if content_files %}
              <div id="content_files_list" class="mt-2">
                <div class="small text-muted mb-1">Current files:</div>
                {% for filename, url in content_files %}
                   <div class="d-flex justify-content-between align-items-center mb-1 small bg-light p-2 rounded" id="content_file_item_{{ forloop.counter }}">
                      <a href="{{ url }}" target="_blank">{{ filename }}</a>
                      <div>
                        <input type="checkbox" class="form-check-input me-2 delete-checkbox" data-field="content" data-filename="{{ filename|escapejs }}" value="{{ filename }}" style="display:none;" name="">
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="markForDelete(this)">
                          Delete
                        </button>
                      </div>
                   </div>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
        {% endif %}
      </div>

      <!-- Submit Buttons -->
      <div class="col-12 mt-4">
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-grow-1">
            <i class="bi bi-save"></i> Save
          </button>
          <a href="{% url 'cv_base_list' %}" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Cancel
          </a>
        </div>
      </div>
      </form>
  </div>
</div>

<!-- Font Awesome & EasyMDE -->
<link rel="stylesheet" href="{% static 'libs/fontawesome/css/font-awesome.min.css' %}">
<link rel="stylesheet" href="{% static 'libs/easymde/easymde.min.css' %}">
<script src="{% static 'libs/easymde/easymde.min.js' %}" defer></script>

<!-- PrismJS for code highlighting in Markdown preview -->
<link href="{% static 'libs/prismjs/themes/prism.min.css' %}" rel="stylesheet"/>
<script src="{% static 'libs/prismjs/prism.min.js' %}" defer></script>
<script src="{% static 'libs/prismjs/plugins/autoloader/prism-autoloader.min.js' %}" defer></script>
<script src="{% static 'libs/marked/marked.min.js' %}" defer></script>

<style>
/* 让工具栏变成弹性盒子，按钮排成一行 */
.editor-toolbar {
  display: flex !important;
  flex-wrap: wrap;
  gap: 2px;
}

.editor-toolbar i,
.editor-toolbar a,
.editor-toolbar button {
  display: inline-flex !important;
  align-items: center;
  justify-content: center;
  width: 30px;
  height: 30px;
}
</style>

<script>
// Function to mark files for deletion
function markForDelete(button) {
  const itemDiv = button.closest('.d-flex');
  const checkbox = itemDiv.querySelector('.delete-checkbox');

  if (checkbox && itemDiv) {
    if (!checkbox.checked) {
      // Mark for deletion
      checkbox.checked = true;
      checkbox.name = checkbox.dataset.field + '_files_delete';
      button.textContent = 'Undo';
      button.classList.remove('btn-outline-danger');
      button.classList.add('btn-outline-success');
      itemDiv.style.backgroundColor = '#ffcdd2';
      itemDiv.style.textDecoration = 'line-through';
      itemDiv.style.opacity = '0.7';
    } else {
      // Unmark for deletion
      checkbox.checked = false;
      checkbox.name = '';
      button.textContent = 'Delete';
      button.classList.remove('btn-outline-success');
      button.classList.add('btn-outline-danger');
      itemDiv.style.backgroundColor = '';
      itemDiv.style.textDecoration = '';
      itemDiv.style.opacity = '1';
    }
  }
}

// Validate file size on selection
function validateFileSize(input) {
  const maxFileSize = {{ max_file_size_bytes }};
  const maxSizeStr = '{{ max_file_size_str }}';
  const files = input.files;

  if (files && files.length > 0) {
    const oversizedFiles = [];

    for (let i = 0; i < files.length; i++) {
      if (files[i].size > maxFileSize) {
        oversizedFiles.push(files[i].name);
      }
    }

    if (oversizedFiles.length > 0) {
      input.value = '';

      const fileList = oversizedFiles.length === 1
        ? oversizedFiles[0]
        : `${oversizedFiles.slice(0, -1).join(', ')} and ${oversizedFiles[oversizedFiles.length - 1]}`;

      alert(`The following file(s) exceed the ${maxSizeStr} limit:\n\n${fileList}\n\nPlease select smaller files and try again.`);

      return false;
    }
  }

  return true;
}

// Show upload loading overlay
function showUploadLoading() {
  let overlay = document.getElementById('upload-loading-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'upload-loading-overlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    `;
    overlay.innerHTML = `
      <div style="
        background: white;
        padding: 30px 50px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      ">
        <div style="
          border: 4px solid #f3f3f3;
          border-top: 4px solid #3498db;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          animation: spin 1s linear infinite;
          margin: 0 auto 15px;
        "></div>
        <style>
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
        <p style="margin: 0; color: #333; font-size: 16px;">Uploading image...</p>
      </div>
    `;
    document.body.appendChild(overlay);
  }
  overlay.style.display = 'flex';
}

// Hide upload loading overlay
function hideUploadLoading() {
  const overlay = document.getElementById('upload-loading-overlay');
  if (overlay) {
    overlay.style.display = 'none';
  }
}

function uploadImage(file, editor) {
  const maxFileSize = {{ max_file_size_bytes }};
  const maxSizeStr = '{{ max_file_size_str }}';

  if (file.size > maxFileSize) {
    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
    alert(`File size (${fileSizeMB} MB) exceeds the ${maxSizeStr} limit.\n\nPlease select a smaller image.`);
    return;
  }

  showUploadLoading();

  const formData = new FormData();
  formData.append('image', file);

  fetch('/upload-image/', {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': '{{ csrf_token }}',
    },
  })
  .then(response => {
    if (response.ok) {
      return response.json();
    } else {
      return response.json().then(data => {
        throw new Error(data.error || 'Image upload failed.');
      });
    }
  })
  .then(data => {
    hideUploadLoading();
    if (data.url) {
      const imageUrl = data.url;
      editor.codemirror.replaceSelection(`![Image](${imageUrl})`);
    }
  })
  .catch(error => {
    hideUploadLoading();
    console.error('Error:', error);
    alert(error.message || 'Image upload failed.');
  });
}

// 配置 marked.js 代码高亮
marked.setOptions({
  gfm: true,
  breaks: true,
  highlight: function (code, lang) {
    if (lang && Prism.languages[lang]) {
      return Prism.highlight(code, Prism.languages[lang], lang);
    }
    return Prism.highlight(code, Prism.languages.plaintext, 'plaintext');
  }
});

// 反转义HTML
function unescapeHtml(str) {
  if (typeof str !== 'string') return str;
  try {
    const doc = new DOMParser().parseFromString(str, 'text/html');
    return doc.documentElement.textContent;
  } catch (e) {
    const textarea = document.createElement('textarea');
    textarea.innerHTML = str;
    return textarea.value;
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // 初始化 Markdown 编辑器
  const textarea = document.getElementById('content-editor');
  if (textarea) {
    // 反转义内容
    if (textarea.value) {
      textarea.value = unescapeHtml(textarea.value);
    }

    // 初始化 EasyMDE 编辑器
    const editor = new EasyMDE({
      element: textarea,
      autoDownloadFontAwesome: false,
      spellChecker: false,
      previewRender: function(plainText) {
        return marked.parse(plainText);
      },
      toolbar: [
        "heading", "bold", "italic", "strikethrough",
        "|", "code",
        {
          name: "code-block",
          action: function customCodeBlock(editor) {
            const cm = editor.codemirror;
            const start = '```\n';
            const end = '\n```';
            cm.replaceSelection(start + cm.getSelection() + end);
            cm.setCursor(cm.getCursor().line + 1, 0);
          },
          className: "fa fa-file-code-o",
          title: "Code Block"
        },
        "|", "quote", "unordered-list", "ordered-list",
        "|", "link", "image", "table", "horizontal-rule",
        "|", "preview", "side-by-side",
        "|",
        {
          name: "upload",
          action: function customUpload(editor) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = () => uploadImage(input.files[0], editor);
            input.click();
          },
          className: "fa fa-upload",
          title: "Upload Image (max {{ max_file_size_str }})"
        },
        {
          name: "paste",
          action: function pasteMarkdown(editor) {
            editor.codemirror.replaceSelection(`**${new Date().toLocaleString()}**`);
          },
          className: "fa fa-clock-o",
          title: "Insert DateTime"
        },
        "|", "guide",
        "|", "fullscreen"
      ]
    });

    // 反转义 title 输入框
    const titleInput = document.querySelector('[name="title"]');
    if (titleInput && titleInput.value) {
      titleInput.value = unescapeHtml(titleInput.value);
    }

    // 添加文件大小验证
    const fileInputs = document.querySelectorAll('input[type="file"][name$="_files"]');
    fileInputs.forEach(input => {
      input.addEventListener('change', function(e) {
        validateFileSize(this);
      });
    });
  }
});

// Calendar Modal functions (global for onclick handlers)
let currentDateForModal = new Date();
let existingDates = [];
let isEditingExistingRecord = false;
const currentRecordId = {{ cv_record.id|default:"null" }};

function openDateModal() {
  const recordDateInput = document.querySelector('[name="record_date"]');
  const currentDateStr = recordDateInput.value;

  if (currentDateStr) {
    currentDateForModal = new Date(currentDateStr);
  } else {
    currentDateForModal = new Date();
  }

  // Determine if editing existing record
  isEditingExistingRecord = {% if cv_record.title or cv_record.content %}true{% else %}false{% endif %};

  loadCalendarData(currentDateForModal.getFullYear(), currentDateForModal.getMonth() + 1);

  const modal = document.getElementById('dateModal');
  modal.removeAttribute('aria-hidden');
  modal.classList.add('show');
  modal.style.display = 'block';
}

function closeDateModal() {
  const modal = document.getElementById('dateModal');
  modal.setAttribute('aria-hidden', 'true');
  modal.classList.remove('show');
  modal.style.display = 'none';
}

function loadCalendarData(year, month) {
  fetch(`/cv-base/calendar-days/?year=${year}&month=${month}`)
    .then(response => response.json())
    .then(data => {
      existingDates = data.existing_dates || [];
      renderDateCalendar();
    })
    .catch(error => console.error('Error loading calendar data:', error));
}

function renderDateCalendar() {
  const year = currentDateForModal.getFullYear();
  const month = currentDateForModal.getMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

  document.getElementById('dateModalTitle').textContent = `${year} ${monthNames[month]}`;

  const daysContainer = document.getElementById('dateModalDays');
  daysContainer.innerHTML = '';

  for (let i = 0; i < firstDay; i++) {
    const emptyCell = document.createElement('div');
    emptyCell.className = 'calendar-day';
    daysContainer.appendChild(emptyCell);
  }

  const recordDateInput = document.querySelector('[name="record_date"]');
  const currentDateStr = recordDateInput.value;

  for (let day = 1; day <= daysInMonth; day++) {
    const dayCell = document.createElement('div');
    dayCell.className = 'calendar-day';
    dayCell.textContent = day;

    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

    if (dateStr === currentDateStr) {
      dayCell.classList.add('selected');
    }

    if (dateStr === currentDateStr) {
      dayCell.addEventListener('click', () => selectDate(year, month, day));
    } else if (existingDates.includes(day)) {
      dayCell.classList.add('disabled');
    } else {
      dayCell.addEventListener('click', () => selectDate(year, month, day));
    }

    daysContainer.appendChild(dayCell);
  }
}

function changeDateModalMonth(delta) {
  currentDateForModal.setMonth(currentDateForModal.getMonth() + delta);
  loadCalendarData(currentDateForModal.getFullYear(), currentDateForModal.getMonth() + 1);
}

function selectDate(year, month, day) {
  const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  const recordDateInput = document.querySelector('[name="record_date"]');

  if (!isEditingExistingRecord) {
    recordDateInput.value = dateStr;
    closeDateModal();
  } else {
    const currentDateStr = recordDateInput.value;

    if (dateStr === currentDateStr) {
      closeDateModal();
      return;
    }

    if (existingDates.includes(day)) {
      alert(`A record already exists for ${dateStr}. Please choose a different date.`);
      return;
    }

    recordDateInput.value = dateStr;
    closeDateModal();
  }
}

function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
}
</script>

<!-- Date Modal -->
<div class="modal fade" id="dateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-gradient-nav">
        <h5 class="modal-title text-white">Select Date</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="closeDateModal()"></button>
      </div>
      <div class="modal-body p-0">
        <div class="calendar-modal">
          <div class="calendar-header">
            <button class="calendar-nav" onclick="changeDateModalMonth(-1)">
              <i class="bi bi-chevron-left"></i>
            </button>
            <span class="calendar-title" id="dateModalTitle"></span>
            <button class="calendar-nav" onclick="changeDateModalMonth(1)">
              <i class="bi bi-chevron-right"></i>
            </button>
          </div>
          <div class="calendar-grid">
            <div class="calendar-day-label">Sun</div>
            <div class="calendar-day-label">Mon</div>
            <div class="calendar-day-label">Tue</div>
            <div class="calendar-day-label">Wed</div>
            <div class="calendar-day-label">Thu</div>
            <div class="calendar-day-label">Fri</div>
            <div class="calendar-day-label">Sat</div>
          </div>
          <div class="calendar-grid" id="dateModalDays"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.calendar-modal {
  position: relative;
  max-width: 400px;
  margin: 0 auto;
}

.calendar-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.calendar-grid {
  padding: 1rem;
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.25rem;
}

.calendar-day-label {
  text-align: center;
  font-weight: 600;
  color: #6c757d;
  padding: 0.5rem 0;
  font-size: 0.875rem;
}

.calendar-day {
  text-align: center;
  padding: 0.5rem;
  cursor: pointer;
  border-radius: 0.375rem;
  transition: background-color 0.2s;
  font-size: 0.9rem;
}

.calendar-day:hover:not(.disabled) {
  background-color: #e9ecef;
}

.calendar-day.disabled {
  color: #adb5bd;
  cursor: not-allowed;
}

.calendar-day.selected {
  background-color: #0d6efd;
  color: white;
}

.calendar-nav {
  background: none;
  border: none;
  color: white;
  font-size: 1.2rem;
  cursor: pointer;
  padding: 0 0.5rem;
}

.calendar-nav:hover {
  opacity: 0.8;
}

.calendar-title {
  font-weight: 600;
}
</style>
{% endblock %}
