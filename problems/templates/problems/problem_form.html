{% extends 'problems/base.html' %}
{% block content %}
<style>
  .form-check-input.custom-checkbox {
    width: 1.2em;
    height: 1.2em;
    margin-top: 0.1em;
    background-color: #fff;
    border: 2px solid #0d6efd;
    border-radius: 0.25em;
  }

  .form-check-input.custom-checkbox:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='m6 10 3 3 6-6'/%3e%3c/svg%3e");
  }

  .form-check-input.custom-checkbox:focus {
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }
</style>

<div class="container py-5">
  <div class="card custom-card p-4">
    <h2 class="mb-4 text-center">{{ action }} Item</h2>
      <form method="post" enctype="multipart/form-data" class="row g-3 form-wrapper">
      {% csrf_token %}

      <div class="col-12">
        <div class="form-check">
          <input class="form-check-input custom-checkbox" type="checkbox" name="is_public" id="id_is_public" {% if form.instance.is_public and form.instance.pk %}checked{% endif %}>
          <label class="form-check-label fw-bold" for="id_is_public" style="color: #495057;">View Publicly</label>
        </div>
      </div>

      <!-- Key Words -->
      <div class="col-12">
        <label class="form-label" for="{{ form.key_words.id_for_label }}">Key Words</label>
        {{ form.key_words }}
        {% if form.key_words.errors %}<div class="text-danger small">{{ form.key_words.errors|join:", " }}</div>{% endif %}
      </div>

      <!-- Title -->
      <div class="col-12">
        <label class="form-label" for="{{ form.title.id_for_label }}">Topic Title</label>
        {{ form.title }}
        {% if form.title.errors %}<div class="text-danger small">{{ form.title.errors|join:", " }}</div>{% endif %}
      </div>

      <!-- 其余字段 -->
      {% for field in form %}
        {% if field.name not in 'key_words,title,is_public' %}
          <div class="col-12">
            <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% if field.errors %}<div class="text-danger small">{{ field.errors|join:", " }}</div>{% endif %}
          </div>
        {% endif %}
      {% endfor %}

      <div class="col-12 text-center">
        <button class="btn btn-primary px-4">Save</button>
        <a class="btn btn-outline-secondary px-4 ms-2" href="{% url 'problem_list' %}">Cancel</a>
      </div>
    </form>
  </div>
</div>
<script>
// 前端敏感词检查（辅助功能，后端验证是主要的）
function checkSensitiveContent() {
    // 从隐藏字段获取敏感词列表
    const sensitiveWordsElement = document.getElementById('sensitiveWordsData');
    if (!sensitiveWordsElement) return true;
    
    const sensitiveWords = JSON.parse(sensitiveWordsElement.textContent);
    let hasSensitiveContent = false;
    let warningMessage = "您的内容包含潜在的敏感信息: ";
    let detectedWords = [];
    
    // 检查所有文本输入框和文本区域
    document.querySelectorAll('input[type="text"], textarea').forEach(field => {
        const value = field.value.toLowerCase();
        sensitiveWords.forEach(item => {
            if (value.includes(item.word.toLowerCase())) {
                hasSensitiveContent = true;
                if (!detectedWords.includes(item.word)) {
                    detectedWords.push(item.word);
                }
            }
        });
    });
    
    if (hasSensitiveContent) {
        warningMessage += detectedWords.join(', ');
        return confirm(warningMessage + "\n\n确定要继续提交吗?");
    }
    
    return true;
}

// 在DOM完全加载后绑定事件
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!checkSensitiveContent()) {
                e.preventDefault();
            }
        });
    }
});
</script>
<!-- 添加隐藏字段传递敏感词数据 -->
{% if user.is_superuser %}
<script id="sensitiveWordsData" type="application/json">
{{ sensitive_words_json|safe }}
</script>
{% endif %}
{% endblock %}
